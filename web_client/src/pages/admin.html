<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Currencies</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    .header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .header h1 {
      font-size: 2.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p { color: #666; font-size: 1.1rem; margin-bottom: 18px; }

    .nav-links { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .nav-links a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    .nav-links a:hover { background: rgba(102, 126, 234, 0.1); border-color: #667eea; }

    .card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.8);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15); }

    .card h2 {
      color: #2d3748;
      font-size: 1.5rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h2::before {
      content: "";
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }

    .input-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
    }

    label { font-weight: 600; color: #4a5568; font-size: 0.95rem; }

    input, select {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fff;
      color: #2d3748;
      flex: 1;
      min-width: 200px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    button.secondary {
      background: #718096;
      box-shadow: 0 4px 15px rgba(113, 128, 150, 0.3);
    }
    button.secondary:hover { box-shadow: 0 6px 20px rgba(113, 128, 150, 0.5); }

    button.success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }
    button.success:hover { box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6); }

    .message { padding: 12px 16px; border-radius: 10px; margin-top: 12px; font-size: 0.95rem; }
    .message.info { background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid rgba(102, 126, 234, 0.3); }
    .message.error { background: rgba(245, 101, 101, 0.1); color: #c53030; border: 1px solid rgba(245, 101, 101, 0.3); }
    .message.success { background: rgba(72, 187, 120, 0.1); color: #38a169; border: 1px solid rgba(72, 187, 120, 0.3); }

    .result-box {
      margin-top: 16px;
      padding: 18px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td { padding: 14px; text-align: left; border-bottom: 1px solid #e2e8f0; }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    tr:hover { background: rgba(102, 126, 234, 0.05); }

    .row-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.8rem; }
      .header { padding: 20px 25px; }
      .card { padding: 20px; }
      .input-group { flex-direction: column; align-items: stretch; }
      input, select, button { width: 100%; min-width: unset; }
      .row-actions { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üõ†Ô∏è Admin Panel ‚Äî Currencies</h1>
      <p>Kelola master mata uang (aktif/inaktif) dan buat kurs awal (base ‚Üí quote).</p>
      <div class="nav-links">
        <a href="/">üè† Home</a>
        <a href="/admin">üí± Currencies</a>
        <button id="btnLogout" class="secondary">üö™ Logout</button>
      </div>
    </div>

    <div class="card">
      <h2>‚ûï Create Currency + Initial Rate</h2>

      <div class="input-group">
        <input id="code" placeholder="Code (3 huruf, ex: BND)" />
        <input id="name" placeholder="Currency name" />
      </div>

      <div class="input-group">
        <input id="base_code" placeholder="Base code (default USD)" value="USD" />
        <input id="rate" placeholder="Rate (contoh: 1.34)" />
        <input id="rate_date" placeholder="Rate date (YYYYY-MM-DD)" />
      </div>

      <button id="btnCreate" class="success">‚úÖ Create (with rate)</button>

      <div id="msgBox" style="margin-top:12px;"></div>
    </div>

    <div class="card">
      <h2>üìã Currency List</h2>
      <button id="btnRefresh" class="success">üîÑ Refresh</button>

      <div id="list" class="result-box"></div>
      <p id="msg"></p>
    </div>
  </div>

  <script type="module">
    import { apiFetch, getToken, logout } from "/assets/main.js";

    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const msgBox = document.getElementById("msgBox");

    function showMessage(text, type="info") {
      msgBox.innerHTML = `<div class="message ${type}">${text}</div>`;
    }

    function parseJwt(token) {
      try {
        const part = token.split(".")[1];
        const base64 = part.replace(/-/g, "+").replace(/_/g, "/");
        const padded = base64 + "=".repeat((4 - (base64.length % 4)) % 4);
        return JSON.parse(atob(padded));
      } catch {
        return null;
      }
    }

    function requireAdminOrRedirect() {
      const token = getToken();
      if (!token) {
        window.location.href = "/login?admin=1&next=/admin";
        return false;
      }
      const payload = parseJwt(token);
      if (payload?.role !== "admin") {
        window.location.href = "/login?admin=1&next=/admin";
        return false;
      }
      return true;
    }

    if (!requireAdminOrRedirect()) {
      // stop
    }

    document.getElementById("btnLogout").addEventListener("click", logout);

    function showError(e) {
      msg.textContent = `ERROR: ${e.message || e}`;
      if (e.status === 401 || e.status === 403) {
        window.location.href = "/login?admin=1&next=/admin";
      }
    }

    async function refresh() {
      msg.textContent = "Loading currencies...";
      list.innerHTML = "";

      try {
        const data = await apiFetch("/admin/currencies");

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector("tbody");

        data.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><strong>${c.code}</strong></td>
            <td><input value="${c.name ?? ""}" /></td>
            <td>
              <select>
                <option value="active" ${c.status === "active" ? "selected" : ""}>active</option>
                <option value="inactive" ${c.status === "inactive" ? "selected" : ""}>inactive</option>
              </select>
            </td>
            <td class="row-actions">
              <button class="update success">Update</button>
              <button class="delete secondary">Delete</button>
            </td>
          `;

          const nameInput = tr.querySelector("input");
          const statusSelect = tr.querySelector("select");

          tr.querySelector(".update").onclick = async () => {
            try {
              await apiFetch(`/admin/currencies/${c.code}`, {
                method: "PUT",
                body: JSON.stringify({ name: nameInput.value, status: statusSelect.value })
              });
              showMessage(`‚úÖ Updated ${c.code}`, "success");
              await refresh();
            } catch (e) {
              showError(e);
            }
          };

          tr.querySelector(".delete").onclick = async () => {
            if (!confirm(`Delete ${c.code}?`)) return;
            try {
              await apiFetch(`/admin/currencies/${c.code}`, { method: "DELETE" });
              showMessage(`üóëÔ∏è Deleted ${c.code}`, "success");
              await refresh();
            } catch (e) {
              showError(e);
            }
          };

          tbody.appendChild(tr);
        });

        list.appendChild(table);
        msg.textContent = "OK";
      } catch (e) {
        showError(e);
      }
    }

    document.getElementById("btnCreate").onclick = async () => {
      const code = document.getElementById("code").value.trim().toUpperCase();
      const name = document.getElementById("name").value.trim();
      const base_code = (document.getElementById("base_code").value.trim().toUpperCase() || "USD");
      const rate = Number(document.getElementById("rate").value.trim());
      const rate_date = document.getElementById("rate_date").value.trim();

      if (code.length !== 3) return showMessage("‚ùå Code harus 3 huruf (contoh: BND)", "error");
      if (!name) return showMessage("‚ùå Name wajib diisi", "error");
      if (!Number.isFinite(rate) || rate <= 0) return showMessage("‚ùå Rate harus angka > 0", "error");
      if (!rate_date || rate_date.length !== 10) return showMessage("‚ùå Rate date harus YYYY-MM-DD", "error");

      try {
        await apiFetch("/admin/currencies-with-rate", {
          method: "POST",
          body: JSON.stringify({ code, name, base_code, rate, rate_date })
        });
        showMessage("‚úÖ Currency + initial rate created", "success");
        await refresh();
      } catch (e) {
        showError(e);
      }
    };

    document.getElementById("btnRefresh").onclick = refresh;
    refresh();
  </script>
</body>
</html>
