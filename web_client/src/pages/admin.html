<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Currencies</title>
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
  <h1>Admin Panel â€” Currencies</h1>

  <p>
    <a href="/">Home</a> 
    
   
  </p>

  <p><b>Total kunjungan halaman Admin (browser ini):</b> <span id="visitCount">0</span></p>

  <button id="btnLogout">Logout</button>

  <hr/>

  <h2>Create Currency + Initial Rate</h2>
  <input id="code" placeholder="Code (3 huruf, ex: BND)" />
  <input id="name" placeholder="Currency name" />
  <br /><br />
  <input id="base_code" placeholder="Base code (default USD)" value="USD" />
  <input id="rate" placeholder="Rate (contoh: 1.34)" />
  <input id="rate_date" placeholder="Rate date (YYYY-MM-DD)" />
  <br /><br />
  <button id="btnCreate">Create (with rate)</button>

  <hr/>

  <h2>Currency List</h2>
  <button id="btnRefresh">Refresh</button>
  <div id="list"></div>

  <p id="msg"></p>

  <script type="module">
    import { apiFetch, getToken, logout } from "/assets/main.js";

    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const visitCount = document.getElementById("visitCount");

    // visit counter
    (function countVisit() {
      const key = "visits_admin_panel";
      const n = Number(localStorage.getItem(key) || "0") + 1;
      localStorage.setItem(key, String(n));
      visitCount.textContent = String(n);
    })();

    function parseJwt(token) {
      try {
        const payload = token.split(".")[1];
        const json = atob(payload.replace(/-/g, "+").replace(/_/g, "/"));
        return JSON.parse(decodeURIComponent(escape(json)));
      } catch {
        return null;
      }
    }

    function requireAdminOrRedirect() {
      const token = getToken();
      if (!token) {
        window.location.href = "/login?admin=1&next=/admin";
        return false;
      }
      const payload = parseJwt(token);
      if (payload?.role !== "admin") {
        window.location.href = "/login?admin=1&next=/admin";
        return false;
      }
      return true;
    }

    if (!requireAdminOrRedirect()) {
      // stop
    }

    document.getElementById("btnLogout").addEventListener("click", logout);

    function showError(e) {
      msg.textContent = `ERROR: ${e.message || e}`;
      if (e.status === 401 || e.status === 403) {
        window.location.href = "/login?admin=1&next=/admin";
      }
    }

    async function refresh() {
      msg.textContent = "Loading currencies...";
      list.innerHTML = "";

      try {
        const data = await apiFetch("/admin/currencies"); // backend route

        const table = document.createElement("table");
        table.border = "1";
        table.cellPadding = "6";

        table.innerHTML = `
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        `;

        data.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.code}</td>
            <td><input value="${c.name ?? ""}" /></td>
            <td>
              <select>
                <option value="active" ${c.status === "active" ? "selected" : ""}>active</option>
                <option value="inactive" ${c.status === "inactive" ? "selected" : ""}>inactive</option>
              </select>
            </td>
            <td>
              <button class="update">Update</button>
              <button class="delete">Delete</button>
            </td>
          `;

          const nameInput = tr.querySelector("input");
          const statusSelect = tr.querySelector("select");

          tr.querySelector(".update").onclick = async () => {
            try {
              await apiFetch(`/admin/currencies/${c.code}`, {
                method: "PUT",
                body: JSON.stringify({ name: nameInput.value, status: statusSelect.value })
              });
              msg.textContent = `Updated ${c.code}`;
              await refresh();
            } catch (e) {
              showError(e);
            }
          };

          tr.querySelector(".delete").onclick = async () => {
            if (!confirm(`Delete ${c.code}?`)) return;
            try {
              await apiFetch(`/admin/currencies/${c.code}`, { method: "DELETE" });
              msg.textContent = `Deleted ${c.code}`;
              await refresh();
            } catch (e) {
              showError(e);
            }
          };

          table.appendChild(tr);
        });

        list.appendChild(table);
        msg.textContent = "OK";
      } catch (e) {
        showError(e);
      }
    }

    document.getElementById("btnCreate").onclick = async () => {
      const code = document.getElementById("code").value.trim().toUpperCase();
      const name = document.getElementById("name").value.trim();
      const base_code = (document.getElementById("base_code").value.trim().toUpperCase() || "USD");
      const rate = Number(document.getElementById("rate").value.trim());
      const rate_date = document.getElementById("rate_date").value.trim();

      try {
        await apiFetch("/admin/currencies-with-rate", {
          method: "POST",
          body: JSON.stringify({ code, name, base_code, rate, rate_date })
        });
        msg.textContent = "Currency + initial rate created";
        await refresh();
      } catch (e) {
        showError(e);
      }
    };

    document.getElementById("btnRefresh").onclick = refresh;
    refresh();
  </script>
</body>
</html>
