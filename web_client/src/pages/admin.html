<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin - Currencies</title>
</head>
<body>
  <h1>Admin Panel — Currencies</h1>

  <button id="btnLogout">Logout</button>
  <p><a href="/dashboard">Dashboard</a> | <a href="/">Home</a></p>

  <h2>Create Currency + Initial Rate</h2>
  <input id="code" placeholder="Code (3 huruf, ex: BND)" />
  <input id="name" placeholder="Currency name" />

  <br /><br />

  <!-- Rate awal -->
  <input id="base_code" placeholder="Base code (default USD)" value="USD" />
  <input id="rate" placeholder="Rate (contoh: 1.34)" />
  <input id="rate_date" placeholder="Rate date (YYYY-MM-DD)" value="2026-01-04" />

  <br /><br />
  <button id="btnCreate">Create (with rate)</button>

  <h2>Currency List</h2>
  <button id="btnRefresh">Refresh</button>
  <div id="list"></div>

  <p id="msg"></p>

  <script type="module">
    import { apiFetch, getToken, logout } from "/assets/main.js";

    const msg = document.getElementById("msg");
    const list = document.getElementById("list");

    // harus login
    if (!getToken()) {
      window.location.href = "/login";
    }

    document.getElementById("btnLogout").addEventListener("click", logout);

    function showError(e) {
      msg.textContent = `ERROR: ${e.message}`;

      if (e.status === 401) {
        msg.textContent = "Session expired / token invalid. Redirecting to login...";
        setTimeout(() => logout(), 600);
      }

      if (e.status === 403) {
        msg.textContent = "Access denied (not admin). Login pakai akun admin.";
      }
    }

    async function refresh() {
      msg.textContent = "Loading currencies...";
      list.innerHTML = "";

      try {
        const data = await apiFetch("/admin/currencies");

        const table = document.createElement("table");
        table.border = "1";
        table.cellPadding = "6";

        table.innerHTML = `
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        `;

        data.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.code}</td>
            <td><input value="${c.name ?? ""}" /></td>
            <td>
              <select>
                <option value="active" ${c.status === "active" ? "selected" : ""}>active</option>
                <option value="inactive" ${c.status === "inactive" ? "selected" : ""}>inactive</option>
              </select>
            </td>
            <td>
              <button class="update">Update</button>
              <button class="delete">Delete</button>
            </td>
          `;

          const nameInput = tr.querySelector("input");
          const statusSelect = tr.querySelector("select");

          tr.querySelector(".update").onclick = async () => {
            try {
              await apiFetch(`/admin/currencies/${c.code}`, {
                method: "PUT",
                body: JSON.stringify({
                  name: nameInput.value,
                  status: statusSelect.value
                })
              });
              msg.textContent = `Updated ${c.code}`;
              await refresh();
            } catch (e) {
              showError(e);
            }
          };

          tr.querySelector(".delete").onclick = async () => {
            if (!confirm(`Delete ${c.code}?`)) return;
            try {
              await apiFetch(`/admin/currencies/${c.code}`, { method: "DELETE" });
              msg.textContent = `Deleted ${c.code}`;
              await refresh();
            } catch (e) {
              showError(e);
            }
          };

          table.appendChild(tr);
        });

        list.appendChild(table);
        msg.textContent = "OK";
      } catch (e) {
        showError(e);
      }
    }

    // ✅ Create currency + initial rate (Opsi A)
    document.getElementById("btnCreate").onclick = async () => {
      const code = document.getElementById("code").value.trim();
      const name = document.getElementById("name").value.trim();

      const base_code = (document.getElementById("base_code").value.trim() || "USD").toUpperCase();
      const rate = Number(document.getElementById("rate").value);
      const rate_date = document.getElementById("rate_date").value.trim();

      if (!code || code.length !== 3) {
        msg.textContent = "ERROR: code harus 3 huruf (contoh: XAA)";
        return;
      }
      if (!name) {
        msg.textContent = "ERROR: name wajib diisi";
        return;
      }
      if (!base_code || base_code.length !== 3) {
        msg.textContent = "ERROR: base_code harus 3 huruf (contoh: USD)";
        return;
      }
      if (!Number.isFinite(rate) || rate <= 0) {
        msg.textContent = "ERROR: rate harus angka > 0";
        return;
      }
      if (!rate_date || rate_date.length !== 10) {
        msg.textContent = "ERROR: rate_date harus format YYYY-MM-DD";
        return;
      }

      try {
        await apiFetch("/admin/currencies-with-rate", {
          method: "POST",
          body: JSON.stringify({ code, name, base_code, rate, rate_date })
        });

        msg.textContent = "Currency + initial rate created";

        // reset input
        document.getElementById("code").value = "";
        document.getElementById("name").value = "";
        document.getElementById("rate").value = "";

        await refresh();
      } catch (e) {
        showError(e);
      }
    };

    document.getElementById("btnRefresh").onclick = refresh;

    refresh();
  </script>
</body>
</html>
