<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Open Currency Platform</title>
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>ğŸ“Š Dashboard</h1>
        <div class="nav-links">
          <a href="/">ğŸ  Home</a>
          <a href="/explorer">ğŸŒ Explorer</a>
          <button id="btnLogout" class="btn-logout">ğŸšª Logout</button>
        </div>
      </div>
      <div class="stats-bar">
        <strong>ğŸ“ˆ Total kunjungan halaman:</strong>
        <span class="count" id="visitCount">0</span>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“Š Kuota API Key</h2>
      <div class="quota-grid">
        <div class="quota-item">
          <label>Kuota per API Key</label>
          <div class="value" id="quotaLimitText">100</div>
          <small style="color:#666;">total request (tidak reset harian)</small>
        </div>
        <div class="quota-item">
          <label>Sisa Kuota</label>
          <div class="value" id="quotaRemainText">-</div>
          <small style="color:#666;">untuk API key terakhir</small>
        </div>
      </div>
      <p id="quotaMsg" class="message error" style="display:none;"></p>
    </div>

    <div class="card">
      <h2>ğŸ”‘ Buat API Key Baru</h2>
      <div class="form-group">
        <label for="label">Label (opsional)</label>
        <input id="label" placeholder="Contoh: Production API, Testing Key, dll..." />
      </div>

      <button id="btnCreate">âœ¨ Create Key</button>

      <div style="margin-top:25px;">
        <h3 style="color:#2d3748; font-size:1.1rem; margin-bottom:10px;">ğŸ” New Key (simpan sekarang)</h3>
        <div class="key-display" id="newKey">-</div>

        <div class="button-group">
          <button id="btnOpenExplorer" class="success" style="display:none;">
            ğŸš€ Buka Explorer (API key tersimpan)
          </button>
        </div>
      </div>

      <p id="msg"></p>
    </div>
  </div>

  <script type="module">
    import { apiFetch, getToken, logout } from "/assets/main.js";

    const msg = document.getElementById("msg");
    const newKey = document.getElementById("newKey");
    const btnOpenExplorer = document.getElementById("btnOpenExplorer");
    const visitCount = document.getElementById("visitCount");

    const quotaLimitText = document.getElementById("quotaLimitText");
    const quotaRemainText = document.getElementById("quotaRemainText");
    const quotaMsg = document.getElementById("quotaMsg");

    // visit counter
    (function countVisit() {
      const key = "visits_user_dashboard";
      const n = Number(localStorage.getItem(key) || "0") + 1;
      localStorage.setItem(key, String(n));
      visitCount.textContent = String(n);
    })();

    // guard login
    if (!getToken()) {
      window.location.href = "/login?next=/dashboard";
    }

    document.getElementById("btnLogout").addEventListener("click", logout);

    async function getBackendUrl() {
      const r = await fetch("/config");
      const j = await r.json();
      return j.backendUrl;
    }

    function persistLastApiKey(apiKey) {
      localStorage.setItem("demo_api_key", apiKey);
      sessionStorage.setItem("last_created_api_key", apiKey);
    }

    async function refreshQuotaForKey(apiKey) {
      if (!apiKey) {
        quotaRemainText.textContent = "-";
        quotaMsg.style.display = "none";
        return;
      }

      try {
        const backendUrl = await getBackendUrl();
        const r = await fetch(`${backendUrl}/api/v1/currency/quota`, {
          headers: { "x-api-key": apiKey }
        });
        const data = await r.json();

        if (!r.ok) {
          quotaMsg.textContent = "âš ï¸ " + (data?.error || "Gagal cek kuota");
          quotaMsg.style.display = "block";
          quotaRemainText.textContent = "-";
          return;
        }

        // âœ… field baru
        quotaLimitText.textContent = String(data.limit_total ?? 100);
        quotaRemainText.textContent = String(data.remaining_total ?? "-");
        quotaMsg.style.display = "none";
      } catch {
        quotaMsg.textContent = "âš ï¸ Gagal cek kuota (network error)";
        quotaMsg.style.display = "block";
        quotaRemainText.textContent = "-";
      }
    }

    async function showLastKeyUI() {
      const last = sessionStorage.getItem("last_created_api_key");
      if (last && last.trim()) {
        newKey.textContent = last;
        btnOpenExplorer.style.display = "inline-block";
        await refreshQuotaForKey(last);
      } else {
        newKey.textContent = "-";
        btnOpenExplorer.style.display = "none";
        await refreshQuotaForKey(null);
      }
    }

    btnOpenExplorer.addEventListener("click", () => {
      window.location.href = "/explorer";
    });

    document.getElementById("btnCreate").addEventListener("click", async () => {
      const labelInput = document.getElementById("label");
      const label = labelInput.value.trim();

      msg.textContent = "Creating key...";
      const btn = document.getElementById("btnCreate");
      btn.disabled = true;

      try {
        const data = await apiFetch("/keys", {
          method: "POST",
          body: JSON.stringify({ label })
        });

        const apiKey = data.api_key;
        if (!apiKey) {
          msg.textContent = "Key dibuat, tapi response tidak mengandung api_key.";
          return;
        }

        persistLastApiKey(apiKey);

        newKey.textContent = apiKey;
        btnOpenExplorer.style.display = "inline-block";

        labelInput.value = "";
        await refreshQuotaForKey(apiKey);

        msg.textContent = "âœ… Key created & saved. Klik 'Buka Explorer'.";
      } catch (err) {
        msg.textContent = "âŒ Create failed: " + err.message;
      } finally {
        btn.disabled = false;
      }
    });

    await showLastKeyUI();
  </script>
</body>
</html>
